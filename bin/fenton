#!/usr/bin/env ruby

require 'fenton'
require 'gli'
require 'highline/import'

include GLI::App

program_desc 'manage and sign SSH Keys from Fenton Server'

desc "Show current version number"
version Fenton::VERSION

desc 'Be verbose'
switch 'verbose'

sort_help :manually

public_key_default = "#{ENV['HOME']}/.ssh/id_ecdsa.pub"

desc 'Manage your SSH Keys'
arg_name 'key'

command :key do |c|
  c.desc 'Sign your local ssh public key'
  arg_name 'sign'

  c.command :sign do |c1|
    c1.flag [:p, :public_key], desc: "Your SSH Pubic Key"

    c1.action do |global_options,options,args|
      puts "Signing public key."

      if options[:p] != public_key_default
        options[:p] = ask("Enter public key to submit (#{public_key_default}): ")
        options[:p] = public_key_default if options[:p].empty?
        exit_now!("No file found by that name #{options[:p]}") unless File.exists?(options[:p])
      end

      exit_now!("No file found by that name #{options[:p]}") unless File.exists?(options[:p])
      
      Fenton::Key.sign(global_options,options,args)
    end
  end

  c.desc 'Get information about your keys'
  arg_name 'show'

  c.command :show do |c1|
    c1.command :ca do |c2|
      c2.action do |global_options,options,args|
        Fenton::Key.ca_public_key(global_options,options,args)
      end
    end
  end
end

# on_error do |ex|
  
# end

exit run(ARGV)
